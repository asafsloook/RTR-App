<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>בדרך להחלמה</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

    <script src="AjaxCalls.js"></script>

    <script>

        //global variables for ride management
        rides = null;
        idChoose = null;

        //global variables for filter management
        dayChoose = "יום";
        dateChoose = "תאריך";
        shiftChoose = "כיוון";
        areaChoose = "איזור";
        startChoose = "מוצא";
        endChoose = "יעד";

        //get the rides list on load
        $(document).ready(function () {
            getRidesList();
        });

        //call the ajax function to import the rides list
        function getRidesList() {
            var request = {
                test: "test",
            }
            GetRides(request, GetRidesSuccessCB, GetRidesErrorCB);
        }

        //success call back function for get rides
        function GetRidesSuccessCB(resutls) {

            resutls = $.parseJSON(resutls.d)
            rides = resutls;

            printRides(resutls, 4);
        }

        //error call back function for get rides
        function GetRidesErrorCB(e) {
            alert("I caught the exception : failed in GetRidesErrorCB \n The exception message is : " + e.responseText);
        }

        //success call back function for get rides
        function GetMyRidesSuccessCB(resutls) {

            myRides = $.parseJSON(resutls.d)


            str = "";
            for (var i = 0; i < myRides.length; i++) {

                var myDate = new Date(parseInt(myRides[i].DateTime.replace('/Date(', '')));

                var day = numToDayHebrew(myDate.getDay());

                str += '<li data-theme="a">'
                    + '<a id="popDEL' + i + '" href="#deleteMePopup" data-rel="popup" data-position-to="window" '
                    + '   data-transition="pop" '
                    + ' class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-icon-edit ui-btn-icon-left ui-btn-b" '
                    + '  onClick="delInfo(' + myRides[i].Id + ')">'
                    + '<p>יום ' + day
                    + ', ' + myDate.getDate() + "/" + (myDate.getMonth() + 1) + "/" + myDate.getFullYear()
                    + ', ' + myDate.toTimeString().replace(/.*?(\d{2}:\d{2}).*/, "$1") + '</p>'
                    + '<p>מ-' + myRides[i].StartPoint + ' '
                    + 'ל-' + myRides[i].EndPoint + ', '
                    + '' + myRides[i].Person;

                if (myRides[i].Melave.length > 0) {
                    str += " +" + (myRides[i].Melave.length)
                }
            }
            str += '</p>'
                + "</a>"
                + "</li> ";


            var counterStr = '<p style="margin:0px;">מספר הנסיעות: ' + myRides.length + '</p>';



            $("#myRidesPH").html(str);
            $("#myRidesPH").listview("refresh");
            $("#myRidesCounterPH").html(counterStr);

        }

        function delInfo(rideID) {
            if (rideID != undefined) {
                idDeleteChoose = rideID;
            }

            request = {
                id: idDeleteChoose
            }
        }

        function deleteMyRide() {

            deleteRide(request, deleteRideSuccessCB, deleteRideErrorCB)


        }


        //success call back function for delete ride
        function deleteRideSuccessCB() {

            var request = {
                id: "123",
            }
            GetMyRides(request, GetMyRidesSuccessCB, GetMyRidesErrorCB);
        }

        //error call back function for delete ride
        function deleteRideErrorCB(e) {
            alert("I caught the exception : failed in GetRidesErrorCB \n The exception message is : " + e.responseText);
        }

        //error call back function for get my rides
        function GetMyRidesErrorCB(e) {
            alert("I caught the exception : failed in GetRidesErrorCB \n The exception message is : " + e.responseText);
        }

        function printRides(resutls, numOfWantedSeats) {

            str = "";
            ridesCounter = 0;

            for (var i = 0; i < resutls.length; i++) {

                var myDate = new Date(parseInt(resutls[i].DateTime.replace('/Date(', '')));

                var day = numToDayHebrew(myDate.getDay());

                //filter
                if (shiftChoose != "כיוון" && shiftChoose != resutls[i].Shift) {
                    continue;
                }
                if (dayChoose != "יום" && dayChoose != day) {
                    continue;
                }
                if (dateChoose != "תאריך" && dateChoose != myDate.toLocaleDateString()) {
                    continue;
                }
                if (areaChoose != "איזור" && areaChoose != resutls[i].Area) {
                    continue;
                }
                if (startChoose != "מוצא" && startChoose != resutls[i].StartPoint) {
                    continue;
                }
                if (endChoose != "יעד" && endChoose != resutls[i].EndPoint) {
                    continue;
                }

                //filter by seats
                if (numOfWantedSeats < (resutls[i].Melave.length) + 1) {
                    continue;
                }

                str += '<li data-theme="b">'
                    + '<a id="pop' + i + '" href="#signMePopup" data-rel="popup" data-position-to="window" '
                    + '   data-transition="pop" '
                    + ' class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-icon-edit ui-btn-icon-left ui-btn-b" '
                    + '  onClick="info(' + resutls[i].Id + ')">'
                    + '<p>יום ' + day
                    + ', ' + myDate.getDate() + "/" + (myDate.getMonth() + 1) + "/" + myDate.getFullYear()
                    + ', ' + myDate.toTimeString().replace(/.*?(\d{2}:\d{2}).*/, "$1") + '</p>'
                    + '<p>מ-' + resutls[i].StartPoint + ' '
                    + 'ל-' + resutls[i].EndPoint + ', '
                    + '' + resutls[i].Person;

                if (resutls[i].Melave.length > 0) {
                    str += " +" + (resutls[i].Melave.length)
                }
                str += '</p>'
                    + "</a>"
                    + "</li> ";
                ridesCounter++;
            }

            if (ridesCounter==0) {
                var counterStr = '<p>לא נמצאו נסיעות  <a id="clearFilter" href="#" style="background-color:#202020" data-role="button" data-inline="true" data-theme="b" class="ui-button ui-button-inline ui-widget ui-button-a ui-link ui-btn ui-btn-b ui-btn-icon-left ui-btn-inline ui-shadow ui-corner-all ui-icon-refresh" role="button">נקה</a></p>';
            }
            else {
                var counterStr = '<p style="margin:0px;">מספר הנסיעות: ' + ridesCounter + '</p>';
            }
            

            $("#ridesPH").html(str);
            $("#ridesPH").listview("refresh");
            $("#counterPH").html(counterStr);
        }

        function getRideStr(rideOBJ) {

            var myDate = new Date(parseInt(rideOBJ.DateTime.replace('/Date(', '')));

            var day = numToDayHebrew(myDate.getDay());

            var str = '<p>יום ' + day
                + ', ' + myDate.getDate() + "/" + (myDate.getMonth() + 1) + "/" + myDate.getFullYear()
                + ', ' + myDate.toTimeString().replace(/.*?(\d{2}:\d{2}).*/, "$1") + '</p>'
                + '<p>מ-' + rideOBJ.StartPoint + ' '
                + 'ל-' + rideOBJ.EndPoint + ', '
                + '<br/>' + rideOBJ.Person + '</p>';
            if (rideOBJ.Melave.length > 0) {
                str += '<p>מלווים: ';

                for (var i = 0; i < rideOBJ.Melave.length; i++) {
                    str += rideOBJ.Melave[i] + "<br/>";
                }

                str += '</p>';
            }


            return str;
        }

        //get the ride info
        function info(inputID) {

            idChoose = inputID;

            for (var i = 0; i < rides.length; i++) {
                if (rides[i].Id == idChoose) {
                    var str = getRideStr(rides[i]);
                }
            }

            $("#phPop").html(str);

        }

        function signDriverSuccessCB(resutls) {
            getRidesList();
        }

        //error call back function for get rides
        function signDriverErrorCB(e) {
            alert("I caught the exception : failed in signDriverErrorCB \n The exception message is : " + e.responseText);
        }

        //function for converting num of day to hebrew day
        function numToDayHebrew(i) {
            var day = "";
            switch (i) {
                case 0:
                    day = "א";
                    break;
                case 1:
                    day = "ב";
                    break;
                case 2:
                    day = "ג";
                    break;
                case 3:
                    day = "ד";
                    break;
                case 4:
                    day = "ה";
                    break;
                case 5:
                    day = "ו";
                    break;
                case 6:
                    day = "ש";
            }
            return day;
        }

        //fill the date ddl dynamicly (30 days forward)
        $(document).ready(function () {
            var str = "<option>תאריך</option>";
            for (var i = 0; i < 30; i++) {

                var nowDate = new Date();
                var myDate = new Date(nowDate.setDate(nowDate.getDate() + i));

                str += "<option>" + myDate.toLocaleDateString() + "</option>"; //myDate.getDate() + "/" + (myDate.getMonth() + 1) + "/" + myDate.getFullYear()
            }

            $('#dateDDL').html(str);
            $("#dateDDL").selectmenu("refresh");

        });


        //handle the filter events
        $(document).ready(function () {
            $('#dayDDL').change(function () {
                dayChoose = $('#dayDDL').val();
                printRides(rides, 4);
            });
        });

        $(document).ready(function () {
            $('#dateDDL').change(function () {
                dateChoose = $('#dateDDL').val();
                printRides(rides, 4);
            });
        });

        $(document).ready(function () {
            $('#shiftDDL').change(function () {
                shiftChoose = $('#shiftDDL').val();
                printRides(rides, 4);
            });
        });

        $(document).ready(function () {
            $('#areaDDL').change(function () {
                areaChoose = $('#areaDDL').val();
                printRides(rides, 4);
            });
        });

        $(document).ready(function () {
            $('#startDDL').change(function () {
                startChoose = $('#startDDL').val();
                printRides(rides, 4);
            });
        });

        $(document).ready(function () {
            $('#endDDL').change(function () {
                endChoose = $('#endDDL').val();
                printRides(rides, 4);
            });
        });

        //trigger the tab (active) when ok btn is pressed
        $(document).ready(function () {
            $("#cancelBTN").on("click", function () {
                $('#signMeTab').click();
            });
        });


        function checkRides(resutls, id) {
            suitedArr = [];
            var HaveSuitedRides = false;

            for (var i = 0; i < resutls.length; i++) {

                var rideDate = new Date(parseInt(resutls[i].DateTime.replace('/Date(', '')));
                var chooseRideDate = new Date(parseInt(ride.DateTime.replace('/Date(', '')));
                if (rideDate.toDateString() != chooseRideDate.toDateString()) {
                    continue;
                }
                //dateChoose = rideDate.toLocaleDateString();

                if (resutls[i].Id == idChoose) {
                    continue;
                }

                //filter
                if (ride.Shift != resutls[i].Shift) {
                    continue;
                }
                //shiftChoose = resutls[i].Shift;

                if (ride.Area != resutls[i].Area) {
                    continue;
                }
                //areaChoose = ride.Area;

                if (ride.StartPoint != resutls[i].StartPoint) {
                    continue;
                }
                //startChoose = ride.StartPoint;

                if (ride.EndPoint != resutls[i].EndPoint) {
                    continue;
                }
                //endChoose = ride.EndPoint;

                //dayChoose = numToDayHebrew(rideDate.getDay());

                if (availibleSeats < (resutls[i].Melave.length + 1)) {
                    continue;
                }

                HaveSuitedRides = true;
                suitedArr.push(resutls[i]);
            }

            return HaveSuitedRides;

        }


        //add dynamic data to suggest page
        $(document).ready(function () {

            $("#okBTN").on("click", function () {

                var request = {
                    id: idChoose
                };

                signDriver(request, signDriverSuccessCB, signDriverErrorCB);


                for (var i = 0; i < rides.length; i++) {
                    if (rides[i].Id == idChoose) {
                        ride = rides[i];
                    }
                }

                maxSeats = 4;

                if (ride.Melave.length > 0) {
                    totalPassengers = (ride.Melave.length + 1);
                }
                else {
                    totalPassengers = 1;
                }


                availibleSeats = maxSeats - totalPassengers;

                var str = "";

                getRidesList();

                var haveRides;

                if (checkRides(rides, idChoose)) {
                    haveRides = true;
                }

                if (haveRides) {
                    str += '<p><b>נוסעים נוספים יכולים להצטרף לנסיעה</b></p>';
                }

                var myDate = new Date(parseInt(ride.DateTime.replace('/Date(', '')));
                var day = numToDayHebrew(myDate.getDay());
                str += '<p>ביום ' + day
                    + ', ' + myDate.getDate() + "/" + (myDate.getMonth() + 1) + "/" + myDate.getFullYear()
                    + ', בשעה ' + myDate.toTimeString().replace(/.*?(\d{2}:\d{2}).*/, "$1") + '</p>'
                    + '<p>מ-' + ride.StartPoint + ' '
                    + 'ל-' + ride.EndPoint + '.</p>';

                if (haveRides) {
                    str += /*"<p> כמות הנוסעים בנסיעה כעת: " + totalPassengers + "</p>" +*/
                        "<p> מושבים פנויים ברכבך: " + maxSeats
                        + '<a data-icon="edit" id="updateSeatsBTN" href="#" style="background-color:#202020" data-role="button" data-inline="true" data-theme="b" class="ui-button ui-button-inline ui-widget ui-button-a ui-link ui-btn ui-btn-b ui-icon-edit ui-btn-icon-left ui-btn-inline ui-shadow ui-corner-all" role="button">עדכן</a>'
                        + '</p><p>האם אתה מעוניין לצרף לנסיעה את ' + suitedArr[0].Person;



                    if (suitedArr.length == 0) {

                    }
                    else {
                        if (suitedArr[0].Melave.length == 0) {
                            str += "?";
                        }
                        else if (suitedArr[0].Melave.length == 1) {
                            str += " ו" + suitedArr[0].Melave[0] + "?";
                        }
                        else {
                            for (var i = 0; i < suitedArr[0].Melave.length; i++) {


                                if (i == suitedArr[0].Melave.length - 1) {
                                    str += " ו" + suitedArr[0].Melave[i] + "?";
                                }
                                else {
                                    str += ", " + suitedArr[0].Melave[i] + " ";
                                }
                            }
                        }
                    }


                    str += "</p>";



                    $("#updateSeatsBTN").show();
                    $("#suggestCancelBTN").show();
                    $("#suggestOkBTN").text("נשמע טוב");
                }
                else {
                    $("#updateSeatsBTN").hide();
                    $("#suggestCancelBTN").hide();
                    $("#suggestOkBTN").text("קבענו");
                }

                $("#phSuggest").html(str);
            });
        });

        //move to myRides after signing to ride and click cancel
        $(document).ready(function () {
            $("#suggestCancelBTN").on("click", function () {
                //$('#myRidesTab').click();
                //setTimeout(function () {
                //    $('#myRidesTab').click();
                //}, 1000);
            });
        });



        //move to signMe tab after signing to ride and click ok
        $(document).ready(function () {
            $("#suggestOkBTN").on("click", function () {


                if (suitedArr.length > 0) {
                    idChoose = parseInt(suitedArr[0].Id);

                }
                var request = {
                    id: idChoose
                };

                signDriver(request, signDriverSuccessCB, signDriverErrorCB);
                //printRides(rides, (4 - totalPassengers));

               

            });
        });
        //trigger the tab (active) when the page has been load
        $(document).ready(function () {
            $('#signMeTab').click();
        });

        $(document).ready(function () {
            $(document).on('pageshow', '#home', function () {
                $('#signMeTab').click();
            });
        });

        //tabs control
        $(document).ready(function () {
            $(document).on('click', '#deletecancelBTN', function () {
                $('#myRidesTab').click();
            });
        });
        $(document).ready(function () {
            $(document).on('click', '#deleteokBTN', function () {
                $('#myRidesTab').click();
            });
        });

        $(document).ready(function () {
            $(document).on('click', '#signMeTab', function () {
                getRidesList();
            });
        });

        $(document).ready(function () {
            $(document).on('click', '#myRidesTab', function () {

                var request = {
                    id: "123",
                }
                GetMyRides(request, GetMyRidesSuccessCB, GetMyRidesErrorCB);
            });
        });

        $(document).ready(function () {
            $(document).on('click', '#clearFilter', function () {
                
                $("#dayDDL").prop('selectedIndex', 0);
                $("#dayDDL").selectmenu("refresh");
                $("#endDDL").prop('selectedIndex', 0);
                $("#endDDL").selectmenu("refresh");
                $("#startDDL").prop('selectedIndex', 0);
                $("#startDDL").selectmenu("refresh");
                $("#areaDDL").prop('selectedIndex', 0);
                $("#areaDDL").selectmenu("refresh");
                $("#shiftDDL").prop('selectedIndex', 0);
                $("#shiftDDL").selectmenu("refresh");
                $("#dateDDL").prop('selectedIndex', 0);
                $("#dateDDL").selectmenu("refresh");

                dayChoose = "יום";
                dateChoose = "תאריך";
                shiftChoose = "כיוון";
                areaChoose = "איזור";
                startChoose = "מוצא";
                endChoose = "יעד";

                printRides(rides, 4);
            });
        });
        



    </script>

    <style>
        option, select {
            direction: rtl;
            max-width: 100px;
        }

        .ui-listview > .ui-li-static, .ui-listview > .ui-li-divider, .ui-listview > li > a.ui-btn {
            text-align: right;
            font-size: 20px;
           
        }

        #ridesPH li a, #myRidesPH li a {
            border-color: #e4e4e4;
            margin-top: 5px;
        }
        
        .ui-li-desc, p, h1, h2, h3 {
            text-align: center;
            direction: rtl;
        }

        #tabs {
            min-height: 640px;
        }

        fieldset {
            text-align: center;
        }

        #ridesCounter {
            /*right: 78%;
            top: 12px;
            border-radius: 16px;
            background-color: #660000;*/
            /*background-color: #fa3e3e;
            border-radius: 21px;
            color: white;
            padding: 1px 3px;
            font-size: 10px;
            position: absolute;
            top: 7px;
            right: 100px;*/
        }
    </style>
</head>
<body>


    <div data-role="page" id="home">

        <div data-role="tabs" id="tabs">
            <h1 data-theme="b">בדרך להחלמה</h1>
            <div data-role="navbar">

                <ul>
                    <li><a id="historyTab" href="#history" data-theme="b">היסטוריה</a></li>
                    <li><a id="myRidesTab" href="#myRides" data-theme="b">הנסיעות שלי<!--<span id="ridesCounter" class="ui-li-count ui-btn-up-c ui-btn-corner-all">12</span>--> </a> </li>
                    <li><a id="signMeTab" href="#signMe" data-theme="b">שבץ אותי</a></li>
                </ul>
            </div>

            <div id="signMe">

                <div data-role="content">

                    <div data-role="popup" id="signMePopup" data-overlay-theme="a" data-theme="a" data-dismissible="false" class="ui-corner-all ui-popup ui-overlay-shadow ui-body-a">
                        <div role="main" class="ui-corner-bottom ui-content">
                            <div id="phPop"></div>
                            <a data-icon="check" id="okBTN" href="#suggest" style="background-color:#004d00" data-role="button" data-inline="true" data-rel="dialog" data-transition="flow" data-theme="b" class="ui-button ui-shadow ui-corner-all ui-button-inline ui-widget ui-button-b" role="button">שבץ אותי</a>
                            <a data-icon="delete" id="cancelBTN" href="#" style="background-color:#660000" data-role="button" data-inline="true" data-rel="back" data-theme="b" class="ui-button ui-shadow ui-corner-all ui-button-inline ui-widget ui-button-a" role="button">בטל</a>
                        </div>
                    </div>


                    <div>
                        <fieldset data-role="controlgroup" data-type="horizontal" data-icon="false" class="ui-grid-a" data-theme="a">

                            <select id="shiftDDL" data-iconpos="left">
                                <option>כיוון</option>
                                <option>בוקר</option>
                                <option>אחהצ</option>
                            </select>

                            <select id="dateDDL" data-iconpos="left"></select>

                            <select id="dayDDL" data-iconpos="left">
                                <option>יום</option>
                                <option>א</option>
                                <option>ב</option>
                                <option>ג</option>
                                <option>ד</option>
                                <option>ה</option>
                                <option>ו</option>
                                <option>ש</option>
                            </select>

                        </fieldset>

                        <fieldset data-role="controlgroup" data-type="horizontal" data-theme="a">

                            <select id="endDDL" data-iconpos="left">
                                <option>יעד</option>
                                <option>ארז</option>
                                <option>רמבם</option>
                                <option>ג'למה</option>
                                <option>אייל</option>
                                <option>שיבא</option>
                                <option>ירושלים</option>
                            </select>

                            <select id="startDDL" data-iconpos="left">
                                <option>מוצא</option>
                                <option>ארז</option>
                                <option>רמבם</option>
                                <option>ג'למה</option>
                                <option>אייל</option>
                                <option>שיבא</option>
                                <option>ירושלים</option>
                            </select>

                            <select id="areaDDL" data-iconpos="left">
                                <option>איזור</option>
                                <option>דרום</option>
                                <option>מרכז</option>
                                <option>צפון</option>
                            </select>

                        </fieldset>
                    </div>



                    <div id="counterPH" data-role="fieldcontain">

                    </div>

                    <ul id="ridesPH" data-role="listview" data-inset="true" data-icon="false" data-theme="a"></ul>

                </div>

            </div>

            <div id="myRides">

                <div data-role="popup" id="deleteMePopup" data-overlay-theme="a" data-theme="a" data-dismissible="false" class="ui-corner-all ui-popup ui-overlay-shadow ui-body-a">
                    <div role="main" class="ui-corner-bottom ui-content">
                        <div id="phPopDelete"></div>
                        <a data-icon="check" id="deleteokBTN" href="#" style="background-color:#004d00" data-role="button" data-inline="true" data-rel="back" data-transition="flow" data-theme="b" class="ui-button ui-shadow ui-corner-all ui-button-inline ui-widget ui-button-b" role="button">סגור</a>
                        <a data-icon="delete" onclick="deleteMyRide()" id="deletecancelBTN" href="#" style="background-color:#660000" data-role="button" data-rel="back" data-inline="true" data-theme="b" class="ui-button ui-shadow ui-corner-all ui-button-inline ui-widget ui-button-a" role="button">בטל את הנסיעה</a>
                    </div>
                </div>

                <div id="myRidesCounterPH" data-role="fieldcontain">

                </div>

                <ul id="myRidesPH" data-role="listview" data-inset="true" data-icon="false" data-theme="b"></ul>
            </div>

            <div id="history">
                HISTORY
            </div>

        </div>
    </div>

    <div data-role="page" id="suggest" style="text-align:center">

        <h1 data-theme="b">נרשמת בהצלחה!</h1>
        <div id="phSuggest"></div>
        <a data-icon="check" id="suggestOkBTN" href="#" style="background-color:#004d00" data-role="button" data-inline="true" data-rel="back" data-transition="flow" data-theme="b" class="ui-button ui-shadow ui-corner-all ui-button-inline ui-widget ui-button-b" role="button">נשמע טוב</a>
        <a data-icon="delete" id="suggestCancelBTN" href="#" style="background-color:#660000" data-role="button" data-inline="true" data-rel="back" data-theme="b" class="ui-button ui-shadow ui-corner-all ui-button-inline ui-widget ui-button-a" role="button">לא מעוניין</a>
    </div>


</body>
</html>